class YandexPay
{
    constructor(params)
    {
        this.paymentSession = null;
        this.amount = params.amount;
        this.YaPay = window.YaPay;
        this.productId = params.productId;
        this.obBtn = BX('showWidget' + this.productId);
        this.merchantId = params.merchantId;
        this.obWidget = null;
        this.paymentData = {
            env: (params.DEMO === 'Y') ? this.YaPay.PaymentEnv.Sandbox : this.YaPay.PaymentEnv.Production,
            version: 4,
            currencyCode: this.YaPay.CurrencyCode.Rub,
            merchantId: this.merchantId,
            totalAmount: this.amount,
            availablePaymentMethods: ['SPLIT']
        }
    }

    Init()
    {
        if (this.paymentSession) {
            this.paymentSession.unmountWidget(this.obBtn);
            this.paymentSession.destroy();
        }
        jQuery(this.obBtn).unbind('click');
        jQuery(this.obBtn).on('click', this.showWidget.bind(this));
    }

    InitWidget()
    {
        let self = this;

        self.obWidget = document.createElement('div');
        self.obWidget.classList.add('yandexPayWidget');
        self.obWidget.classList.add('yandexYP'+self.productId);
        self.obWidget.style.display = 'none';

        let close = document.createElement('span');
        close.classList.add('close');
        close.innerText = '+';
        close.onclick = function() {
            self.obWidget.style.display = 'none';
        };

        self.obWidget.append(close);
        document.body.append(self.obWidget);
    }

    showWidget()
    {
        let self = this;

        BX.cleanNode(self.obWidget, true);
        self.obWidget = null;

        if(!self.obWidget)
            self.InitWidget();

        self.YaPay.createSession(self.paymentData, {
            onPayButtonClick: function() {}
        })
            .then(function(paymentSession) {
                self.paymentSession = paymentSession;
                paymentSession.mountWidget(
                    self.obWidget,
                    {
                        widgetType: self.YaPay.WidgetType.BnplPreview,
                    }
                );
                self.obWidget.style.display = 'block';
            })
    }

}